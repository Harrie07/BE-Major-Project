# docker-compose.yml

# Using version 3.8, though the 'version' key is considered obsolete in newer Compose versions.
# It's kept for compatibility but will be ignored by newer Docker Compose versions.
version: '3.8'

# Define the services that make up your application
services:
  # --- Database Service: PostgreSQL with PostGIS extension ---
  db:
    image: postgis/postgis:16-3.5
    container_name: mumbai-geo-ai-backend-db-1
    environment:
      # PostgreSQL user, password, and database name
      # These must match the credentials expected by other services (app, titiler)
      POSTGRES_USER: mumbai_user
      POSTGRES_PASSWORD: janmoksathi
      POSTGRES_DB: mumbai_geo_ai
    volumes:
      # Persist database data in a named volume
      - postgres_data:/var/lib/postgresql/data
    ports:
      # Map host port 5432 to container port 5432
      - "5432:5432"
    healthcheck:
      # Check if PostgreSQL is ready for the specific user and database
      test: ["CMD-SHELL", "pg_isready -U mumbai_user -d mumbai_geo_ai"]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped

  # --- Redis Service: In-memory data structure store ---
  redis:
    image: redis:7-alpine
    container_name: mumbai-geo-ai-backend-redis-1
    ports:
      # Map host port 6379 to container port 6379
      - "6379:6379"
    healthcheck:
      # Simple ping check to verify Redis is responsive
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped

  # --- MinIO Service: High Performance Object Storage ---
  minio:
    image: minio/minio:latest
    container_name: mumbai-geo-ai-backend-minio-1
    environment:
      # MinIO root user credentials
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin123
      MINIO_DOMAIN: localhost
    ports:
      # Map host ports 9000 (API) and 9001 (Console) to container ports
      - "9000:9000"
      - "9001:9001"
    volumes:
      # Persist MinIO data in a named volume
      - minio_data:/data
    # Start MinIO server with console address
    command: server /data --console-address ":9001"
    healthcheck:
      # Check MinIO health endpoint
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
      start_period: 30s
    restart: unless-stopped

  # --- TiTiler Service: FIXED VERSION ---
  titiler:
    # FIXED: Use standard TiTiler image instead of PGSTAC version
    image: ghcr.io/developmentseed/titiler:latest
    container_name: mumbai-geo-ai-backend-titiler-1
    ports:
      # Map host port 8001 to container port 80 (TiTiler's actual internal port)
      - "8001:80"
    environment:
      # --- GDAL and PROJ optimizations for geospatial operations ---
      CPL_TMPDIR: /tmp
      GDAL_CACHEMAX: 200
      GDAL_DISABLE_READDIR_ON_OPEN: EMPTY_DIR
      GDAL_HTTP_MERGE_CONSECUTIVE_RANGES: YES
      GDAL_HTTP_MULTIPLEX: YES
      GDAL_HTTP_VERSION: 2
      PYTHONWARNINGS: ignore
      VSI_CACHE: TRUE
      VSI_CACHE_SIZE: 5000000

      # REMOVED: Database configuration (not needed for standard TiTiler)
      # The titiler-pgstac image needs database config, but standard TiTiler doesn't

    # FIXED: Correct health check endpoint and port
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 60s # Reduced startup time
    restart: unless-stopped
    # REMOVED: Database dependency (standard TiTiler doesn't need database)

  # --- Your Mumbai Geo-AI Application ---
  app:
    # Build the application image from the current directory using Dockerfile
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mumbai-geo-ai-backend-app-1
    ports:
      # Map host port 8000 to container port 8000 (FastAPI's default)
      - "8000:8000"
    environment:
      # --- Database configuration ---
      # Use service names for Docker networking
      POSTGRES_USER: mumbai_user
      POSTGRES_PASSWORD: janmoksathi
      POSTGRES_DB: mumbai_geo_ai
      POSTGRES_HOST: db
      POSTGRES_PORT: 5432

      # --- Redis configuration ---
      # Use service names for Docker networking
      REDIS_HOST: redis
      REDIS_PORT: 6379

      # --- MinIO configuration ---
      # Use service names and credentials for Docker networking
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin123
      MINIO_ENDPOINT: minio:9000
      MINIO_SECURE: "False"
      MINIO_BUCKET_NAME: mumbai-geo-ai

      # --- TiTiler configuration ---
      # Use service name for Docker networking - FIXED PORT
      TITILER_ENDPOINT: http://titiler:80

      # --- Application configuration ---
      API_V1_STR: /api/v1
      PROJECT_NAME: Mumbai Geo-AI Backend
      DEBUG: "False"

      # --- PROJ library fix for Docker ---
      # Point to the system-installed PROJ data directory
      PROJ_LIB: /usr/share/proj

    # Ensure dependencies are healthy before starting the app
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
      titiler: # Wait for TiTiler to be healthy
        condition: service_healthy

    volumes:
      # Mount your source code for development (remove in production)
      - .:/app
    restart: unless-stopped

  # --- Redis Worker Service: Processes background jobs ---
  worker:
    # Build the worker image from the current directory using Dockerfile
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mumbai-geo-ai-backend-worker-1
    # Command to run the RQ worker for the 'ml_processing' queue
    command: ["rq", "worker", "ml_processing", "--url", "redis://redis:6379/0"]
    environment:
      # --- Same environment as app service for consistency ---
      POSTGRES_USER: mumbai_user
      POSTGRES_PASSWORD: janmoksathi
      POSTGRES_DB: mumbai_geo_ai
      POSTGRES_HOST: db
      POSTGRES_PORT: 5432
      REDIS_HOST: redis
      REDIS_PORT: 6379
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin123
      MINIO_ENDPOINT: minio:9000
      MINIO_SECURE: "False"
      MINIO_BUCKET_NAME: mumbai-geo-ai
      TITILER_ENDPOINT: http://titiler:80
      PROJ_LIB: /usr/share/proj # Match app service
    # Ensure dependencies are healthy before starting the worker
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
      # OPTIONAL: Remove TiTiler dependency for worker if not needed
      titiler:
        condition: service_healthy
    volumes:
      # Mount your source code for development (remove in production)
      - .:/app
    restart: unless-stopped
    # ADDED: Health check for worker
    healthcheck:
      test: ["CMD", "python", "-c", "import redis; r=redis.Redis(host='redis', port=6379); r.ping()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

# Define named volumes for persistent data storage
volumes:
  # Volume for PostgreSQL data
  postgres_data:
  # Volume for MinIO data
  minio_data: